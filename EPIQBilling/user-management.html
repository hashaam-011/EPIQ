<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management - Login</title>
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/css/main3860.css?v=1" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- Favicon and Apple Touch Icon -->
  <link rel="icon" type="image/png" href="assets/img/epiq-logo.png">
  <link rel="apple-touch-icon" href="assets/img/epiq-logo.png">
  <style>
    body {
      background: url('assets/img/bill.jpg') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      position: relative;
      margin: 0;
      padding: 0;
      height: 100%;
    }
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1;
    }
    body.dashboard-active::before {
      display: none; /* Hide dark overlay when dashboard is active */
    }
    .login-container {
      position: relative;
      z-index: 2;
      max-width: 450px;
      margin: 60px auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }
    .login-title {
      text-align: center;
      margin-bottom: 30px;
      color: #2c3e50;
      font-weight: 600;
    }
    .form-group {
      margin-bottom: 25px;
    }
    .form-control {
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      transition: all 0.3s ease;
    }
    .form-control:focus {
      border-color: #4a90e2;
      box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
    }
    .btn-primary {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: #4a90e2;
      border: none;
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      background: #357abd;
      transform: translateY(-1px);
    }
    .back-link {
      display: block;
      text-align: center;
      margin-top: 20px;
      color: #666;
      text-decoration: none;
      transition: color 0.3s ease;
    }
    .back-link:hover {
      color: #4a90e2;
    }
    .form-label {
      font-weight: 500;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    .form-select {
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .login-icon {
      text-align: center;
      margin-bottom: 20px;
    }
    .login-icon img {
      width: 80px;
      height: auto;
    }
    .input-group-text {
      background: transparent;
      border-right: none;
    }
    .input-group .form-control {
      border-left: none;
    }
    .input-group .form-control:focus {
      border-left: none;
    }
    /* Dashboard Styles */
    #superadmin-dashboard, #admin-dashboard {
      display: none;
      /* Remove position: fixed and allow normal scrolling */
      position: static;
      width: 100vw;
      min-height: 100vh;
      background: #f8f9fa;
      margin: 0 !important;
      padding: 0 !important;
      z-index: 1000;
      overflow-y: visible;
      box-sizing: border-box;
    }
    .dashboard-container {
      max-width: 1400px;
      margin: 20px auto;
      padding: 30px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      min-height: calc(100vh - 40px);
    }
    #create-admin-container, #create-user-container {
      display: none !important;
    }
    .stat-card {
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      margin-bottom: 20px;
    }
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    .card {
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      border-radius: 10px;
    }
    .card-header {
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    .table {
      width: 100% !important;
      border-collapse: collapse !important;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      margin: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .table th, .table td {
      border: 1.5px solid #2986d6 !important;
      padding: 12px;
      vertical-align: middle;
      background: #fff;
      font-size: 1rem;
    }
    .table thead th {
      background: #f1f3f5;
      font-weight: 600;
      color: #222;
    }
    .table-responsive {
      width: 100%;
      overflow-x: auto;
      margin-bottom: 1rem;
    }
    @media (max-width: 768px) {
      .table th, .table td {
        font-size: 0.95rem;
        padding: 8px;
      }
    }
    /* Slide-down form styles */
    .slide-down-form {
      display: none;
      overflow: hidden;
      transition: max-height 0.5s cubic-bezier(0.4,0,0.2,1);
      max-height: 0;
      margin-bottom: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 0;
    }
    .slide-down-form.show {
      display: block;
      max-height: 800px;
      padding: 20px;
    }
    .checkmark-success {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 80px;
    }
    .checkmark-success svg {
      width: 60px;
      height: 60px;
      display: block;
    }
    /* Ensure form cards are always full width */
    .card.p-4 {
      width: 100%;
      max-width: 100%;
      margin: 0 auto;
    }
    /* Modern full-width form styles */
    #user-form-area .modern-form {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 2rem;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }
    .modern-form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 2rem;
    }
    .modern-form-field label {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }
    .field-row {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .add-note-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.2s;
    }
    .add-note-btn:hover {
      background: #0056b3;
    }
    .note-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    .note-modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 2rem;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
    }
    .note-modal textarea {
      width: 100%;
      min-height: 120px;
      margin: 1rem 0;
      padding: 1rem;
      border: 1px solid #ced4da;
      border-radius: 4px;
      resize: vertical;
    }
    .note-modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
    }
    .note-modal-buttons button {
      padding: 0.8rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    .note-modal-buttons .save {
      background: #28a745;
      color: white;
      border: none;
    }
    .note-modal-buttons .cancel {
      background: #6c757d;
      color: white;
      border: none;
    }
    /* Make user dashboard and form area full width */
    #user-dashboard-container {
      max-width: 100vw !important;
      width: 100vw !important;
      margin: 0 !important;
      padding: 0 !important;
      border-radius: 0 !important;
      background: transparent !important;
      box-shadow: none !important;
    }
    #user-form-area {
      width: 100vw;
      max-width: 100vw;
      margin: 0 auto;
      padding: 0;
    }
    /* Remove .login-container styles for dashboard */
    #user-dashboard-container .modern-form {
      max-width: 1200px;
      margin: 2rem auto;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      background: #fff;
      padding: 2rem;
    }
    /* Modern dashboard styles */
    #user-dashboard-container {
      max-width: 900px !important;
      width: 100%;
      margin: 40px auto 0 auto !important;
      padding: 40px 32px 32px 32px !important;
      border-radius: 18px !important;
      background: rgba(255,255,255,0.98) !important;
      box-shadow: 0 8px 32px rgba(0,0,0,0.10) !important;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .dashboard-title {
      font-size: 2.2rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 2rem;
      letter-spacing: 1px;
      text-align: center;
    }
    .dashboard-forms-list {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-bottom: 2.5rem;
    }
    .dashboard-form-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 1.2rem 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      transition: box-shadow 0.2s;
    }
    .dashboard-form-row:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.10);
    }
    .dashboard-form-btn {
      flex: 1;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 6px;
      padding: 0.7rem 1.2rem;
      border: none;
      background: #007bff;
      color: #fff;
      transition: background 0.2s;
      cursor: pointer;
    }
    .dashboard-form-btn:hover {
      background: #0056b3;
    }
    .dashboard-add-note-btn {
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.7rem 1.2rem;
      font-size: 1.05rem;
      font-weight: 500;
      margin-left: 0.5rem;
      transition: background 0.2s;
      cursor: pointer;
    }
    .dashboard-add-note-btn:hover {
      background: #218838;
    }
    /* Note Modal Styles */
    .note-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    .note-modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 2rem;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
    }
    .note-modal textarea {
      width: 100%;
      min-height: 120px;
      margin: 1rem 0;
      padding: 1rem;
      border: 1px solid #ced4da;
      border-radius: 4px;
      resize: vertical;
    }
    .note-modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
    }
    .note-modal-buttons button {
      padding: 0.8rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    .note-modal-buttons .save {
      background: #28a745;
      color: white;
      border: none;
    }
    .note-modal-buttons .cancel {
      background: #6c757d;
      color: white;
      border: none;
    }
  </style>
</head>
<body>
  <!-- Login Container -->
  <div class="login-container" id="login-container">
    <div class="login-icon">
      <img src="assets/img/epiq-logo.png" alt="EPIQ Logo">
    </div>
    <h2 class="login-title">Welcome Back</h2>
    <form id="loginForm">
      <div class="form-group">
        <label class="form-label" for="login-email">Email Address</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-envelope"></i></span>
          <input type="email" class="form-control" id="login-email" name="email" placeholder="Enter your email" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label" for="login-password">Password</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-lock"></i></span>
          <input type="password" class="form-control" id="login-password" name="password" placeholder="Enter your password" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label" for="login-role">Role</label>
        <select class="form-select" id="login-role" name="role" required>
          <option value="">Select Your Role</option>
          <option value="admin">Admin</option>
          <option value="superadmin">Super Admin</option>
          <option value="user">User</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-box-arrow-in-right me-2"></i>Sign In
      </button>
    </form>
    <a href="index.html" class="back-link">
      <i class="bi bi-arrow-left me-2"></i>Back to Home
    </a>
  </div>
  <!-- Submission Container -->
  <div class="login-container shadow-lg rounded bg-white" id="submission-container" style="display:none;">
    <h2 class="login-title">Submit Data</h2>
    <form id="submissionForm">
      <div class="form-group">
        <label for="submission-content">Enter something:</label>
        <textarea class="form-control" id="submission-content" name="content" rows="4" required></textarea>
      </div>
      <button type="submit" class="btn btn-success w-100">Submit</button>
    </form>
    <button onclick="window.location.reload()" class="btn btn-outline-secondary w-100 mt-3">← Back</button>
  </div>
  <!-- User Dashboard Container -->
  <div class="login-container" id="user-dashboard-container" style="display:none;">
    <div class="dashboard-title">User Dashboard</div>
    <div class="dashboard-forms-list">
      <div class="dashboard-form-row">
        <button class="dashboard-form-btn" onclick="showForm('outpatient_therapy')">Outpatient Therapy Form</button>
        <button class="dashboard-add-note-btn" onclick="showNoteModal('outpatient_therapy')">Add Note</button>
      </div>
      <div class="dashboard-form-row">
        <button class="dashboard-form-btn" onclick="showForm('medicare_eligibility')">Medicare Eligibility Check</button>
        <button class="dashboard-add-note-btn" onclick="showNoteModal('medicare_eligibility')">Add Note</button>
      </div>
      <div class="dashboard-form-row">
        <button class="dashboard-form-btn" onclick="showForm('home_health_billing_audit')">Home Health Billing Audit (NOA)</button>
        <button class="dashboard-add-note-btn" onclick="showNoteModal('home_health_billing_audit')">Add Note</button>
      </div>
      <div class="dashboard-form-row">
        <button class="dashboard-form-btn" onclick="showForm('coding_needed_list')">Coding Needed List</button>
        <button class="dashboard-add-note-btn" onclick="showNoteModal('coding_needed_list')">Add Note</button>
      </div>
      <div class="dashboard-form-row">
        <button class="dashboard-form-btn" onclick="showForm('final_billing_audit')">Final Billing Audit (PDGM)</button>
        <button class="dashboard-add-note-btn" onclick="showNoteModal('final_billing_audit')">Add Note</button>
      </div>
    </div>
    <div id="user-form-area"></div>
    <button onclick="window.location.reload()" class="btn btn-outline-secondary w-100 mt-3">← Back</button>
    <!-- Note Modal -->
    <div id="noteModal" class="note-modal">
      <div class="note-modal-content">
        <h3>Add Note for <span id="noteFormName"></span></h3>
        <textarea id="modalNoteText" placeholder="Enter your note here..."></textarea>
        <div class="note-modal-buttons">
          <button class="cancel" onclick="closeNoteModal()">Cancel</button>
          <button class="save" onclick="saveNote()">Save Note</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Dashboard Containers -->
  <div id="superadmin-dashboard" style="display:none;"></div>
  <div id="admin-dashboard" style="display:none;"></div>
  <!-- User Management UI -->
  <div class="container-fluid px-4" id="user-management-ui" style="display:none;">
    <h2 class="fw-bold mt-4 mb-3">User Management</h2>
    <div class="row mb-4">
      <div class="col-md-3 mb-2">
        <div class="card shadow-sm p-3">
          <div class="fw-bold">Total earned</div>
          <div class="h5">$2,356 <span class="text-success small">↑ 7.5%</span></div>
          <div class="text-muted small">Last month's growth</div>
        </div>
      </div>
      <div class="col-md-3 mb-2">
        <div class="card shadow-sm p-3">
          <div class="fw-bold">Total cancellations</div>
          <div class="h5">546 <span class="text-danger small">↓ 7.5%</span></div>
          <div class="text-muted small">Last month</div>
        </div>
      </div>
      <div class="col-md-3 mb-2">
        <div class="card shadow-sm p-3">
          <div class="fw-bold">Total review score</div>
          <div class="h5">$2,356 <span class="text-success small">↑ 7.5%</span></div>
          <div class="text-muted small">Last month's growth</div>
        </div>
      </div>
      <div class="col-md-3 mb-2">
        <div class="card shadow-sm p-3">
          <div class="fw-bold">Total member</div>
          <div class="h5">$2,356 <span class="text-success small">↑ 7.5%</span></div>
          <div class="text-muted small">Last month</div>
        </div>
      </div>
    </div>
    <div class="d-flex align-items-center mb-3">
      <ul class="nav nav-pills me-auto">
        <li class="nav-item"><a class="nav-link active" href="#">Clients</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Providers</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Request Time</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Fake Account</a></li>
      </ul>
      <input type="text" class="form-control w-auto me-2" placeholder="Search" style="max-width:200px;">
      <button class="btn btn-outline-primary me-2"><i class="bi bi-download"></i> Download</button>
      <button class="btn btn-warning">Add client</button>
    </div>
    <div class="card shadow-sm">
      <div class="card-body p-0">
        <table class="table align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Email Address</th>
              <th>Booking History</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="user-management-table-body">
            <!-- Table rows will be rendered here by JS -->
          </tbody>
        </table>
      </div>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div>Show <select class="form-select d-inline-block w-auto"><option>8</option></select></div>
      <nav><ul class="pagination mb-0"><li class="page-item active"><a class="page-link" href="#">1</a></li><li class="page-item"><a class="page-link" href="#">2</a></li></ul></nav>
    </div>
  </div>
  <!-- Modals -->
  <div class="modal fade" id="loginFeedbackModal" tabindex="-1" aria-labelledby="loginFeedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginFeedbackModalLabel">Login Status</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="loginFeedbackMessage"></div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="editFormModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Form</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit-form-id">
          <div class="mb-3">
            <label class="form-label">Form Data (JSON)</label>
            <textarea class="form-control" id="edit-form-data" rows="10"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveFormEdit()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit-user-id">
          <div class="mb-3">
            <label class="form-label">First Name</label>
            <input type="text" class="form-control" id="edit-first-name">
          </div>
          <div class="mb-3">
            <label class="form-label">Last Name</label>
            <input type="text" class="form-control" id="edit-last-name">
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="edit-email">
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select class="form-control" id="edit-role">
              <option value="user">User</option>
              <option value="admin">Admin</option>
              <option value="superadmin">Super Admin</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveUserEdit()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script>
    let loggedInUser = null;

    function showLoginFeedback(message, isSuccess) {
      const modal = new bootstrap.Modal(document.getElementById('loginFeedbackModal'));
      if (isSuccess) {
        document.getElementById('loginFeedbackMessage').innerHTML = `
          <div class='checkmark-success'>
            <svg viewBox="0 0 52 52"><circle cx="26" cy="26" r="25" fill="none" stroke="#28a745" stroke-width="4"/><path fill="none" stroke="#28a745" stroke-width="4" d="M14 27l7 7 16-16"/></svg>
          </div>
          <div class='text-success text-center mt-2'>${message}</div>
        `;
        modal.show();
        setTimeout(() => {
          modal.hide();
        }, 1000);
      } else {
        document.getElementById('loginFeedbackMessage').innerHTML = `<span class='text-danger'>${message}</span>`;
        modal.show();
      }
    }

    function logout() {
      localStorage.removeItem('loggedInUser');
      window.location.reload();
    }

    document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const role = document.getElementById('login-role').value;

      try {
        const response = await fetch('http://localhost:3000/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, role })
        });
        const data = await response.json();

        if (data.success) {
          showLoginFeedback(`Login successful! Welcome, ${data.user.first_name} (${data.user.role})`, true);
          loggedInUser = data.user;
          localStorage.setItem('loggedInUser', JSON.stringify(data.user));

          setTimeout(() => {
            // Hide login container
            document.getElementById('login-container').style.display = 'none';

            // Add dashboard-active class to body to hide overlay
            document.body.classList.add('dashboard-active');

            // Show appropriate dashboard
            if (loggedInUser.role === 'superadmin') {
              document.getElementById('superadmin-dashboard').style.display = 'block';
              loadSuperAdminDashboard();
            } else if (loggedInUser.role === 'admin') {
              document.getElementById('admin-dashboard').style.display = 'block';
              loadAdminDashboard(loggedInUser.id);
            } else if (loggedInUser.role === 'user') {
              document.getElementById('user-dashboard-container').style.display = 'block';
            }

            window.scrollTo(0, 0);
            bootstrap.Modal.getInstance(document.getElementById('loginFeedbackModal')).hide();
          }, 1200);
        } else {
          showLoginFeedback('Login failed: ' + data.message, false);
        }
      } catch (err) {
        showLoginFeedback('Server error. Please try again later.', false);
      }
    });

    document.getElementById('submissionForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const content = document.getElementById('submission-content').value;
      if (!loggedInUser) {
        alert('Not logged in!');
        return;
      }
      try {
        const response = await fetch('http://localhost:3000/api/submit-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: loggedInUser.id,
            role: loggedInUser.role,
            content
          })
        });
        const data = await response.json();
        if (data.success) {
          alert('Submission successful!');
          document.getElementById('submissionForm').reset();
        } else {
          alert('Submission failed: ' + data.message);
        }
      } catch (err) {
        alert('Server error. Please try again later.');
      }
    });

    async function loadSuperAdminDashboard() {
      const dash = document.getElementById('superadmin-dashboard');
      dash.innerHTML = '<div class="text-center text-secondary">Loading dashboard...</div>';
      try {
        const res = await fetch('http://localhost:3000/api/superadmin-full-dashboard');
        const data = await res.json();
        if (data.success) {
          let html = `
            <div class="container-fluid px-4 py-4 dashboard-container">
              <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
                <div class="container-fluid">
                  <a class="navbar-brand" href="#">
                    <img src="assets/img/epiq-logo.png" alt="EPIQ Logo" style="height: 40px;">
                  </a>
                  <div class="navbar-nav ms-auto">
                    <span class="nav-item nav-link">Welcome, ${loggedInUser.first_name} (${loggedInUser.role})</span>
                    <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
                  </div>
                </div>
              </nav>
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Super Admin Dashboard</h2>
                <button class="btn btn-primary" onclick="toggleCreateForm('admin')">Create New Admin</button>
              </div>
              <div id="slideDownCreateForm" class="slide-down-form">
                <form id="createAdminForm">
                  <div class="form-group mb-3">
                    <label for="admin-first-name">First Name</label>
                    <input type="text" class="form-control" id="admin-first-name" required>
                  </div>
                  <div class="form-group mb-3">
                    <label for="admin-last-name">Last Name</label>
                    <input type="text" class="form-control" id="admin-last-name">
                  </div>
                  <div class="form-group mb-3">
                    <label for="admin-email">Email</label>
                    <input type="email" class="form-control" id="admin-email" required>
                  </div>
                  <div class="form-group mb-3">
                    <label for="admin-password">Password</label>
                    <input type="password" class="form-control" id="admin-password" required>
                  </div>
                  <button type="submit" class="btn btn-warning">Create Admin</button>
                </form>
              </div>
              <div class="row">
                <div class="col-12">
                  <div class="card">
                    <div class="card-header bg-white py-3">
                      <h5 class="mb-0">Admin Management</h5>
                    </div>
                    <div class="card-body p-0">
                      <div class="table-responsive">
                        <table class="table table-hover mb-0">
                          <thead class="table-light">
                            <tr>
                              <th></th>
                              <th>Admin Name</th>
                              <th>Email</th>
                              <th>Last Login</th>
                              <th>Users</th>
                              <th>Forms</th>
                              <th class="text-end">Actions</th>
                            </tr>
                          </thead>
                          <tbody>`;
          data.admins.forEach(({admin, users}) => {
            const totalForms = users.reduce((sum, user) => sum + (user.forms?.length || 0), 0);
            html += `
              <tr>
                <td><button class="btn btn-sm btn-link" onclick="toggleUserList('admin${admin.id}')"><i class="bi bi-chevron-down"></i></button></td>
                <td>${admin.first_name} ${admin.last_name}</td>
                <td>${admin.email}</td>
                <td>${admin.last_login ? new Date(admin.last_login).toLocaleString() : 'Never'}</td>
                <td>${users.length}</td>
                <td>${totalForms}</td>
                <td class="text-end">
                  <button class="btn btn-sm btn-primary me-1" onclick="editUserModal('${admin.id}')"><i class="bi bi-pencil"></i> Edit</button>
                  <button class="btn btn-sm btn-danger me-1" onclick="deleteUserModal('${admin.id}')"><i class="bi bi-trash"></i> Delete</button>
                </td>
              </tr>
              <tr id="admin${admin.id}" style="display: none;">
                <td colspan="7" class="p-0">
                  <div class="bg-light p-3">
                    <h6 class="mb-3">Users</h6>
                    <div class="table-responsive">
                      <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light">
                          <tr>
                            <th></th>
                            <th>User Name</th>
                            <th>Email</th>
                            <th>Last Login</th>
                            <th>Forms</th>
                            <th>Move</th>
                            <th class="text-end">Actions</th>
                          </tr>
                        </thead>
                        <tbody>`;
            users.forEach(user => {
              const formCount = user.forms?.length || 0;
              html += `
                <tr>
                  <td><button class="btn btn-sm btn-link" onclick="toggleFormList('user${user.id}')"><i class="bi bi-chevron-down"></i></button></td>
                  <td>${user.first_name} ${user.last_name}</td>
                  <td>${user.email}</td>
                  <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                  <td>${formCount}</td>
                  <td><button class="btn btn-sm btn-info" onclick="moveUserModal('${user.id}')">Move</button></td>
                  <td class="text-end">
                    <button class="btn btn-sm btn-primary me-1" onclick="editUserModal('${user.id}')"><i class="bi bi-pencil"></i> Edit</button>
                    <button class="btn btn-sm btn-danger me-1" onclick="deleteUserModal('${user.id}')"><i class="bi bi-trash"></i> Delete</button>
                  </td>
                </tr>
                <tr id="user${user.id}" style="display: none;">
                  <td colspan="7" class="p-0">
                    <div class="bg-white p-3">
                      <h6 class="mb-3">Forms</h6>
                      <div class="table-responsive">
                        <table class="table table-sm table-bordered mb-0">
                          <thead class="table-light">
                            <tr>
                              <th>Form Type</th>
                              <th>Status</th>
                              <th>Submitted At</th>
                              <th class="text-end">Actions</th>
                            </tr>
                          </thead>
                          <tbody>`;
          if (!user.forms || user.forms.length === 0) {
            html += `<tr><td colspan="4" class="text-muted">No forms submitted</td></tr>`;
          } else {
            user.forms.forEach(form => {
              html += `
                <tr>
                  <td>${form.form_type}</td>
                  <td><span class="badge ${form.status === 'final' ? 'bg-success' : 'bg-warning text-dark'}">${form.status}</span></td>
                  <td>${new Date(form.created_at).toLocaleString()}</td>
                  <td class="text-end">
                    <button class="btn btn-sm btn-primary me-1" onclick="editFormModal('${form.id}')"><i class="bi bi-pencil"></i> Edit</button>
                  </td>
                </tr>`;
            });
          }
          html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </td>
            </tr>`;
        });
        html += `
                    </tbody>
                  </table>
                </div>
              </div>
            </td>
          </tr>`;
      });
      html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>`;
      dash.innerHTML = html;
      // Add event listeners for modals and actions here...
    } else {
      dash.innerHTML = '<div class="text-danger">Failed to load dashboard.</div>';
    }
  } catch (err) {
    dash.innerHTML = '<div class="text-danger">Server error loading dashboard.</div>';
  }
}

    async function loadAdminDashboard(adminId) {
      const dash = document.getElementById('admin-dashboard');
      dash.innerHTML = '<div class="text-center text-secondary">Loading users and forms...</div>';
      try {
        const res = await fetch(`http://localhost:3000/api/admin-full-dashboard/${adminId}`);
        const data = await res.json();
        if (data.success) {
          let html = `
            <div class="container-fluid px-4 py-4 dashboard-container">
              <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
                <div class="container-fluid">
                  <a class="navbar-brand" href="#">
                    <img src="assets/img/epiq-logo.png" alt="EPIQ Logo" style="height: 40px;">
                  </a>
                  <div class="navbar-nav ms-auto">
                    <span class="nav-item nav-link">Welcome, ${loggedInUser.first_name} (${loggedInUser.role})</span>
                    <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
                  </div>
                </div>
              </nav>
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Admin Dashboard</h2>
                <button class="btn btn-primary" onclick="toggleCreateForm('user')">Create New User</button>
              </div>
              <div id="slideDownCreateForm" class="slide-down-form">
                <form id="createUserForm">
                  <div class="form-group mb-3">
                    <label for="user-first-name">First Name</label>
                    <input type="text" class="form-control" id="user-first-name" required>
                  </div>
                  <div class="form-group mb-3">
                    <label for="user-last-name">Last Name</label>
                    <input type="text" class="form-control" id="user-last-name">
                  </div>
                  <div class="form-group mb-3">
                    <label for="user-email">Email</label>
                    <input type="email" class="form-control" id="user-email" required>
                  </div>
                  <div class="form-group mb-3">
                    <label for="user-password">Password</label>
                    <input type="password" class="form-control" id="user-password" required>
                  </div>
                  <button type="submit" class="btn btn-info">Create User</button>
                </form>
              </div>
              <div class="row">
                <div class="col-12">
                  <div class="card">
                    <div class="card-header bg-white py-3">
                      <h5 class="mb-0">User Management</h5>
                    </div>
                    <div class="card-body p-0">
                      <div class="table-responsive">
                        <table class="table table-hover mb-0">
                          <thead class="table-light">
                            <tr>
                              <th></th>
                              <th>User Name</th>
                              <th>Email</th>
                              <th>Last Login</th>
                              <th>Forms</th>
                              <th class="text-end">Actions</th>
                            </tr>
                          </thead>
                          <tbody>`;

          data.users.forEach(user => {
            const formCount = user.forms?.length || 0;
            html += `
              <tr>
                <td><button class="btn btn-sm btn-link" onclick="toggleFormList('user${user.id}')"><i class="bi bi-chevron-down"></i></button></td>
                <td>${user.first_name} ${user.last_name}</td>
                <td>${user.email}</td>
                <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                <td>${formCount}</td>
                <td class="text-end"></td>
              </tr>
              <tr id="user${user.id}" style="display: none;">
                <td colspan="6" class="p-0">
                  <div class="bg-white p-3">
                    <h6 class="mb-3">Forms</h6>
                    <div class="table-responsive">
                      <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light">
                          <tr>
                            <th>Form Type</th>
                            <th>Status</th>
                            <th>Submitted At</th>
                            <th class="text-end">Actions</th>
                          </tr>
                        </thead>
                        <tbody>`;
        if (!user.forms || user.forms.length === 0) {
          html += `<tr><td colspan="4" class="text-muted">No forms submitted</td></tr>`;
        } else {
          user.forms.forEach(form => {
            html += `
              <tr>
                <td>${form.form_type}</td>
                <td><span class="badge ${form.status === 'final' ? 'bg-success' : 'bg-warning text-dark'}">${form.status}</span></td>
                <td>${new Date(form.created_at).toLocaleString()}</td>
                <td class="text-end">
                  <button class="btn btn-sm btn-primary me-1" onclick="editFormModal('${form.id}')"><i class="bi bi-pencil"></i> Edit</button>
                </td>
              </tr>`;
          });
        }
        html += `
                    </tbody>
                  </table>
                </div>
              </div>
            </td>
          </tr>`;
      });
      html += `
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>`;
      dash.innerHTML = html;
      // Add event listeners for modals and actions here...
    } else {
      dash.innerHTML = '<div class="text-danger">Failed to load users and forms.</div>';
    }
  } catch (err) {
    dash.innerHTML = '<div class="text-danger">Server error loading users and forms.</div>';
  }
}
    function showForm(formType) {
      const area = document.getElementById('user-form-area');
      if (formType === 'outpatient_therapy') {
        area.innerHTML = `
          <form id="outpatientTherapyForm" class="modern-form">
            <h5 class="mb-3">Outpatient Therapy Medicare Ready To Bill</h5>
            <div class="modern-form-grid">
              <div class="modern-form-field">
                <label>Patient First Name</label>
                <div class="field-row">
                  <input type="text" class="form-control" name="patient_first_name" required>
                  <button type="button" class="add-note-btn" onclick="showNoteModal('patient_first_name')">Add Note</button>
                </div>
              </div>
              <div class="modern-form-field">
                <label>Patient Last Name</label>
                <div class="field-row">
                  <input type="text" class="form-control" name="patient_last_name" required>
                  <button type="button" class="add-note-btn" onclick="showNoteModal('patient_last_name')">Add Note</button>
                </div>
              </div>
              <div class="modern-form-field">
                <label>Date From</label>
                <div class="field-row">
                  <input type="date" class="form-control" name="date_from" required>
                  <button type="button" class="add-note-btn" onclick="showNoteModal('date_from')">Add Note</button>
                </div>
              </div>
              <div class="modern-form-field">
                <label>Date To</label>
                <div class="field-row">
                  <input type="date" class="form-control" name="date_to" required>
                  <button type="button" class="add-note-btn" onclick="showNoteModal('date_to')">Add Note</button>
                </div>
              </div>
              <div class="modern-form-field">
                <label>Therapist First Name</label>
                <div class="field-row">
                  <input type="text" class="form-control" name="therapist_first_name" required>
                  <button type="button" class="add-note-btn" onclick="showNoteModal('therapist_first_name')">Add Note</button>
                </div>
              </div>
              <div class="modern-form-field">
                <label>Therapist Last Name</label>
                <div class="field-row">
                  <input type="text" class="form-control" name="therapist_last_name" required>
                  <button type="button" class="add-note-btn" onclick="showNoteModal('therapist_last_name')">Add Note</button>
                </div>
              </div>
              <div class="modern-form-field">
                <label>NPI</label>
                <div class="field-row">
                  <input type="text" class="form-control" name="npi" required>
                  <button type="button" class="add-note-btn" onclick="showNoteModal('npi')">Add Note</button>
                </div>
              </div>
              <div class="modern-form-field">
                <label>Specialty</label>
                <div class="field-row">
                  <input type="text" class="form-control" name="specialty" required>
                  <button type="button" class="add-note-btn" onclick="showNoteModal('specialty')">Add Note</button>
                </div>
              </div>
            </div>
            <button type="submit" class="btn btn-success w-100 mt-4">Submit</button>
          </form>
          <!-- Note Modal -->
          <div id="noteModal" class="note-modal" style="display:none;">
            <div class="note-modal-content">
              <h3>Add Note</h3>
              <textarea id="modalNoteText" placeholder="Enter your note here..."></textarea>
              <div class="note-modal-buttons">
                <button class="cancel" onclick="closeNoteModal()">Cancel</button>
                <button class="save" onclick="saveNote()">Save Note</button>
              </div>
            </div>
          </div>
        `;
        document.getElementById('outpatientTherapyForm').onsubmit = async function(e) {
          e.preventDefault();
          const formData = new FormData(this);
          const data = {};
          formData.forEach((v, k) => data[k] = v);
          await submitUserForm('outpatient_therapy', data);
        };
      } else if (formType === 'medicare_eligibility') {
        area.innerHTML = `
          <form id="medicareEligibilityForm" class="mb-4">
            <h5 class="mb-3">Medicare Eligibility Check Request Form</h5>
            <div class="mb-2"><input type="text" class="form-control mb-2" name="agency_name" placeholder="Agency Name*" required></div>
            <div class="mb-2"><input type="email" class="form-control mb-2" name="email" placeholder="Email to send report to*" required></div>
            <div class="mb-2"><input type="text" class="form-control mb-2" name="patient_last_name" placeholder="Patient Last Name*" required></div>
            <div class="mb-2"><input type="text" class="form-control mb-2" name="patient_first_name" placeholder="Patient First Name*" required></div>
            <div class="mb-2"><input type="date" class="form-control mb-2" name="dob" placeholder="Date of Birth*" required></div>
            <div class="mb-2"><input type="text" class="form-control mb-2" name="medicare_number" placeholder="Patient Medicare #*" required></div>
            <div class="mb-2"><textarea class="form-control" name="comments" placeholder="Comments"></textarea></div>
            <button type="submit" class="btn btn-success">Submit Medicare Eligibility Form</button>
          </form>
        `;
        document.getElementById('medicareEligibilityForm').onsubmit = async function(e) {
          e.preventDefault();
          const formData = new FormData(this);
          const data = {};
          formData.forEach((v, k) => data[k] = v);
          await submitUserForm('medicare_eligibility', data);
        };
      } else if (formType === 'home_health_billing_audit') {
        area.innerHTML = `
          <form id="homeHealthBillingAuditForm" class="mb-4">
            <div class="card p-4" style="border:2px solid #2986d6; border-radius:10px;">
              <h4 class="text-center fw-bold mb-1" style="text-transform:uppercase;">HOME HEALTH BILLING AUDIT FORM</h4>
              <div class="text-center mb-2" style="font-size:1.2rem; font-weight:500;">Notice of Admission (NOA)</div>
              <div class="text-center mb-2 text-danger" style="font-size:0.95rem;">*NOA MUST BE BILLED WITHIN 5 CALENDAR DAYS AFTER THE EFFECTIVE DATE OF ADMISSION*</div>
              <div class="row g-3 mb-2">
                <div class="col-md-6">
                  <label class="form-label fw-bold">Agency Name:<span class="text-danger">*</span></label>
                  <input type="text" class="form-control" name="agency_name" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">Insurance Company:<span class="text-danger">*</span></label>
                  <input type="text" class="form-control" name="insurance_company" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">Patient's Name:<span class="text-danger">*</span></label>
                  <input type="text" class="form-control" name="patient_name" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">Reviewer's Name:<span class="text-danger">*</span></label>
                  <input type="text" class="form-control" name="reviewer_name" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">Review Date:<span class="text-danger">*</span></label>
                  <input type="date" class="form-control" name="review_date" required>
                </div>
                <div class="col-md-12">
                  <label class="form-label fw-bold">Comments:</label>
                  <textarea class="form-control" name="comments" rows="2"></textarea>
                </div>
              </div>
              <div class="p-3 mb-2" style="border:1.5px solid #2986d6; border-radius:7px;">
                <div class="fw-bold text-uppercase mb-2" style="font-size:1.05rem;">Admission Information:</div>
                <div class="row align-items-center mb-2">
                  <div class="col-md-7">
                    <label class="form-label">Is this a transfer from another home health?<span class="text-danger">*</span></label>
                  </div>
                  <div class="col-md-5">
                    <div class="d-flex align-items-center gap-3">
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="transfer" value="yes" required>
                        <label class="form-check-label">YES</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="transfer" value="no" required>
                        <label class="form-check-label">NO</label>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row mb-2">
                  <div class="col-md-6">
                    <label class="form-label">Date of Admission:<span class="text-danger">*</span></label>
                    <input type="date" class="form-control" name="date_of_admission" required>
                  </div>
                </div>
                <div class="mb-2">
                  <div class="fw-bold">NOTE: PLEASE MAKE SURE THAT YOU HAVE THE FOLLOWING INFORMATION IN YOUR SOFTWARE:</div>
                  <ul class="mb-0">
                    <li>POINT OF ORIGIN OF ADMISSION</li>
                    <li>PATIENT STATUS</li>
                    <li>HIPPS CODE (Default 1AA11)</li>
                  </ul>
                </div>
              </div>
              <div class="p-3 mb-2" style="border:1.5px solid #2986d6; border-radius:7px;">
                <div class="fw-bold text-uppercase mb-2" style="font-size:1.05rem;">Physician Information:</div>
                <div class="row align-items-center">
                  <div class="col-md-8">
                    <label class="form-label">Make sure the attending physician in PECOS<span class="text-danger">*</span></label>
                  </div>
                  <div class="col-md-4">
                    <div class="d-flex align-items-center gap-3">
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="physician_pecos" value="yes" required>
                        <label class="form-check-label">YES</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="physician_pecos" value="no" required>
                        <label class="form-check-label">NO</label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="p-3 mb-2" style="border:1.5px solid #2986d6; border-radius:7px;">
                <div class="fw-bold text-uppercase mb-2" style="font-size:1.05rem;">Disclaimer:</div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="disclaimer" id="disclaimerCheckbox">
                  <label class="form-check-label" for="disclaimerCheckbox" style="font-size:0.97rem;">
                    The above documentation verifies that this health insurance claim is ready for billing. Agency verifies that patient record was reviewed, and that the patient meets the health insurance carrier coverage criteria, schedule has been created, confirmed and authorization number has been entered in software. I authorize all visits listed above to be billed to the patient's health insurance carrier.
                  </label>
                </div>
              </div>
              <div class="text-center mt-3">
                <button type="submit" class="btn btn-success px-4">Submit Home Health Billing Audit</button>
              </div>
            </div>
          </form>
        `;
        document.getElementById('homeHealthBillingAuditForm').onsubmit = async function(e) {
          e.preventDefault();
          const formData = new FormData(this);
          const data = {};
          formData.forEach((v, k) => data[k] = v);
          await submitUserForm('home_health_billing_audit', data);
        };
      } else if (formType === 'coding_needed_list') {
        area.innerHTML = `
          <form id="codingNeededListForm" class="mb-4">
            <h5 class="mb-3">Coding Needed List</h5>
            <div class="table-responsive mb-3">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Patient's First Name</th>
                    <th>Patient's Last Name</th>
                    <th>MRN</th>
                    <th>Payer</th>
                    <th>Episode From</th>
                    <th>Episode To</th>
                    <th>OASIS Type</th>
                  </tr>
                </thead>
                <tbody>
                  ${[1,2,3,4,5,6].map(i => `
                    <tr>
                      <td>${i}</td>
                      <td><input type='text' class='form-control' name='first_name_${i}'></td>
                      <td><input type='text' class='form-control' name='last_name_${i}'></td>
                      <td><input type='text' class='form-control' name='mrn_${i}'></td>
                      <td><input type='text' class='form-control' name='payer_${i}'></td>
                      <td><input type='date' class='form-control' name='episode_from_${i}'></td>
                      <td><input type='date' class='form-control' name='episode_to_${i}'></td>
                      <td>
                        <select class='form-control' name='oasis_type_${i}'>
                          <option value=''>SELECT ONE</option>
                          <option value='CODING ONLY'>CODING ONLY</option>
                          <option value='SOC'>SOC</option>
                          <option value='RECERT'>RECERT</option>
                          <option value='D/C'>D/C</option>
                          <option value='ROC'>ROC</option>
                          <option value='TRANSFER'>TRANSFER</option>
                          <option value='SCIC'>SCIC</option>
                          <option value='HIS'>HIS</option>
                        </select>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            <button type="submit" class="btn btn-success">Submit Coding Needed List</button>
          </form>
        `;
        document.getElementById('codingNeededListForm').onsubmit = async function(e) {
          e.preventDefault();
          const formData = new FormData(this);
          const data = {};
          formData.forEach((v, k) => data[k] = v);
          await submitUserForm('coding_needed_list', data);
        };
      } else if (formType === 'final_billing_audit') {
        area.innerHTML = `
          <form id="finalBillingAuditForm" class="mb-4">
            <div class="card p-4" style="border:2px solid #2986d6; border-radius:10px;">
              <h4 class="text-center fw-bold mb-1" style="text-transform:uppercase;">FINAL BILLING AUDIT FORM - PDGM</h4>
              <div class="text-center mb-2" style="font-size:1.1rem;">All sections with red asterisk are required fields and must be filled out<span class="text-danger">*</span></div>
              <div class="row g-3 mb-2">
                <div class="col-md-6">
                  <label class="form-label fw-bold">Agency Name:<span class="text-danger">*</span></label>
                  <input type="text" class="form-control" name="agency_name" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">Payer Name:<span class="text-danger">*</span></label>
                  <input type="text" class="form-control" name="payer_name" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">Reviewer's Name:<span class="text-danger">*</span></label>
                  <input type="text" class="form-control" name="reviewer_name" required>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold">Review Date:<span class="text-danger">*</span></label>
                  <input type="date" class="form-control" name="review_date" required>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold">Patient's Medical Record No:</label>
                  <input type="text" class="form-control" name="patient_medical_record_no">
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">Patient's Name:<span class="text-danger">*</span></label>
                  <input type="text" class="form-control" name="patient_name" required>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold">30-Day Billing Period:</label>
                  <div class="input-group">
                    <input type="date" class="form-control" name="billing_period_start">
                    <span class="input-group-text">to</span>
                    <input type="date" class="form-control" name="billing_period_end">
                  </div>
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold">Cert Period:</label>
                  <div class="input-group">
                    <input type="date" class="form-control" name="cert_period_start">
                    <span class="input-group-text">to</span>
                    <input type="date" class="form-control" name="cert_period_end">
                  </div>
                </div>
                <div class="col-md-12">
                  <label class="form-label fw-bold">Comments:</label>
                  <textarea class="form-control" name="comments" rows="2"></textarea>
                </div>
              </div>
              <!-- PRE-CLAIM REVIEW -->
              <div class="table-responsive mb-2">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr><th colspan="2">PRE-CLAIM REVIEW</th><th style="width:60px;">YES</th><th style="width:60px;">NO</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="2">Is Review Choice Demonstration Applicable in Your State?<span class="text-danger">*</span></td>
                      <td><input type="radio" name="review_choice_applicable" value="yes" required></td>
                      <td><input type="radio" name="review_choice_applicable" value="no" required></td>
                    </tr>
                    <tr>
                      <td colspan="2">Which Review Choice Did Your Agency Make?</td>
                      <td colspan="2">
                        <select class="form-select" name="review_choice">
                          <option value="">Select</option>
                          <option value="pre-claim">Pre-Claim</option>
                          <option value="post-claim">Post-Claim</option>
                          <option value="minimal">Minimal</option>
                        </select>
                      </td>
                    </tr>
                    <tr>
                      <td colspan="2">Was the UTN (unique tracking number) entered in the software?<span class="text-danger">*</span></td>
                      <td><input type="radio" name="utn_entered" value="yes" required></td>
                      <td><input type="radio" name="utn_entered" value="no" required></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- ADMISSION SOURCE -->
              <div class="table-responsive mb-2">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr><th colspan="2">ADMISSION SOURCE</th><th>INSTITUTIONAL</th><th>COMMUNITY</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="2">
                        <b>Institutional</b> – Start of Care date must be within 14 days of an inpatient acute care hospital, SNF, inpatient rehab facility, inpatient psychiatric facility, or long-term care hospital discharge.<br>
                        <b>Community</b> – Start of Care date is <b>NOT</b> within 14 days of an inpatient acute care hospital, SNF, inpatient rehab facility, inpatient psychiatric facility, or long-term care hospital discharge.<br>
                        <span class="fw-bold">Note:</span> The second RAP for the next 30-day period within the same certification period will be COMMUNITY unless the patient went into the Hospital within the last 14 days of the Start Date of the second billing period.
                      </td>
                      <td><input type="radio" name="admission_source" value="institutional"></td>
                      <td><input type="radio" name="admission_source" value="community"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- PLACE OF SERVICE -->
              <div class="table-responsive mb-2">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr><th colspan="4">PLACE OF SERVICE: (Check appropriate box below)</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Patient's Home</td>
                      <td>ALF: (Assisted Living Facility) Q5002</td>
                      <td>NO: (Not Otherwise Specified) Q5009</td>
                      <td></td>
                    </tr>
                    <tr>
                      <td><input type="checkbox" name="place_home"></td>
                      <td><input type="checkbox" name="place_alf"></td>
                      <td><input type="checkbox" name="place_no"></td>
                      <td></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- PLAN OF CARE (485) -->
              <div class="table-responsive mb-2">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr><th colspan="2">PLAN OF CARE (485)</th><th>YES</th><th>NO</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="2">All Sections Complete, Signed & Dated by Clinician</td>
                      <td><input type="radio" name="plan_sections_complete" value="yes"></td>
                      <td><input type="radio" name="plan_sections_complete" value="no"></td>
                    </tr>
                    <tr>
                      <td colspan="2">Signed/Dated by Doctor</td>
                      <td><input type="radio" name="plan_signed_doctor" value="yes"></td>
                      <td><input type="radio" name="plan_signed_doctor" value="no"></td>
                    </tr>
                    <tr>
                      <td colspan="2">Face to Face Completed and Signed by MD (if applicable)</td>
                      <td><input type="radio" name="plan_face_to_face" value="yes"></td>
                      <td><input type="radio" name="plan_face_to_face" value="no"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- OASIS -->
              <div class="table-responsive mb-2">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr><th colspan="2">OASIS</th><th>YES</th><th>NO</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="2"><b>The entire set of OASIS Assessments that are collected at any point in time during a home health episode of care must be transmitted before the final is billed. Examples: Start of Care, Resumption of Care, Follow-Up (recertification or other), Transfer, Discharge and Death at Home. All OASIS must be transmitted ACCURATELY within 30 days from the date of Assessment.</b></td>
                      <td></td><td></td>
                    </tr>
                    <tr>
                      <td colspan="2">Were all Oasis transmitted?<span class="text-danger">*</span></td>
                      <td><input type="radio" name="oasis_transmitted" value="yes" required></td>
                      <td><input type="radio" name="oasis_transmitted" value="no" required></td>
                    </tr>
                    <tr>
                      <td colspan="2">Was Validation Report Reviewed for any Warnings and/or Errors?<span class="text-danger">*</span></td>
                      <td><input type="radio" name="oasis_validation_reviewed" value="yes" required></td>
                      <td><input type="radio" name="oasis_validation_reviewed" value="no" required></td>
                    </tr>
                    <tr>
                      <td colspan="2">If Warning/Errors found, were they fixed and a corrected Oasis retransmitted? (if applicable)</td>
                      <td><input type="radio" name="oasis_errors_fixed" value="yes"></td>
                      <td><input type="radio" name="oasis_errors_fixed" value="no"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- VERBAL/MODIFICATION ORDERS -->
              <div class="table-responsive mb-2">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr><th colspan="2">VERBAL/MODIFICATION ORDERS</th><th>YES</th><th>NO</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="2">Verbal Orders Signed & Dated by Nurse<span class="text-danger">*</span></td>
                      <td><input type="radio" name="verbal_signed_nurse" value="yes" required></td>
                      <td><input type="radio" name="verbal_signed_nurse" value="no" required></td>
                    </tr>
                    <tr>
                      <td colspan="2">Verbal Orders Signed & Dated by Doctor<span class="text-danger">*</span></td>
                      <td><input type="radio" name="verbal_signed_doctor" value="yes" required></td>
                      <td><input type="radio" name="verbal_signed_doctor" value="no" required></td>
                    </tr>
                    <tr>
                      <td colspan="2">Mod Orders Signed & Dated by Doctor</td>
                      <td><input type="radio" name="mod_orders_signed_doctor" value="yes"></td>
                      <td><input type="radio" name="mod_orders_signed_doctor" value="no"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- PHYSICIAN INFORMATION -->
              <div class="table-responsive mb-2">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr><th colspan="2">Physician Information</th><th>YES</th><th>NO</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="2">Verified Physician is on national PECOS file?<span class="text-danger">*</span></td>
                      <td><input type="radio" name="physician_on_pecos" value="yes" required></td>
                      <td><input type="radio" name="physician_on_pecos" value="no" required></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- SERVICES -->
              <div class="table-responsive mb-2">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr><th colspan="2">SERVICES</th><th>YES</th><th>NO</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="2">Verified that all visits in the schedule/calendar in your software match the actual visits you performed during the episode?<span class="text-danger">*</span></td>
                      <td><input type="radio" name="services_verified" value="yes" required></td>
                      <td><input type="radio" name="services_verified" value="no" required></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- SUPPLIES -->
              <div class="table-responsive mb-2">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr><th colspan="2">SUPPLIES</th><th>YES</th><th>NO</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="2">Wound Care Supplies Provided? (0623)</td>
                      <td><input type="radio" name="supplies_wound_care" value="yes"></td>
                      <td><input type="radio" name="supplies_wound_care" value="no"></td>
                    </tr>
                    <tr>
                      <td colspan="2">Supplies Other Than Wound Care Provided? (0270) i.e. ostomy, foley, etc.</td>
                      <td><input type="radio" name="supplies_other" value="yes"></td>
                      <td><input type="radio" name="supplies_other" value="no"></td>
                    </tr>
                    <tr>
                      <td colspan="2">What Was Cost of Those Supplies?</td>
                      <td colspan="2"><input type="text" class="form-control" name="supplies_cost" placeholder="$ Cost of Supplies"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- DISPOSABLE WOUND VAC -->
              <div class="table-responsive mb-2">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr><th colspan="2">DISPOSABLE WOUND VAC</th><th>YES</th><th>NO</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="2">Was there a Disposable Negative Pressure Wound Therapy Device Provided?</td>
                      <td><input type="radio" name="wound_vac_provided" value="yes"></td>
                      <td><input type="radio" name="wound_vac_provided" value="no"></td>
                    </tr>
                    <tr>
                      <td colspan="2">How Many Disposable NPWT Devices Provided?</td>
                      <td colspan="2"><input type="text" class="form-control" name="wound_vac_count" placeholder="Number of NPWT Devices"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- HOSPICE/HOSPITALIZATION -->
              <div class="table-responsive mb-2">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr><th colspan="2">HOSPICE/HOSPITALIZATION</th><th>YES</th><th>NO</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="2">Was Patient in Hospice?</td>
                      <td><input type="radio" name="hospice" value="yes"></td>
                      <td><input type="radio" name="hospice" value="no"></td>
                    </tr>
                    <tr>
                      <td colspan="2">Was Patient Admitted to Hospital During Episode Period? Make sure no visits are on the schedule during hospital stay</td>
                      <td><input type="radio" name="hospitalized" value="yes"></td>
                      <td><input type="radio" name="hospitalized" value="no"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- MSP PERIODS -->
              <div class="table-responsive mb-2">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr><th colspan="2">MSP PERIODS</th><th>YES</th><th>NO</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="2">Is There an Open Liability Claim?<span class="text-danger">*</span></td>
                      <td><input type="radio" name="msp_liability" value="yes" required></td>
                      <td><input type="radio" name="msp_liability" value="no" required></td>
                    </tr>
                    <tr>
                      <td colspan="2">Is There an Open No-fault Policy Claim?<span class="text-danger">*</span></td>
                      <td><input type="radio" name="msp_nofault" value="yes" required></td>
                      <td><input type="radio" name="msp_nofault" value="no" required></td>
                    </tr>
                    <tr>
                      <td colspan="2">Is There an Open Worker's Compensation Claim?<span class="text-danger">*</span></td>
                      <td><input type="radio" name="msp_workers_comp" value="yes" required></td>
                      <td><input type="radio" name="msp_workers_comp" value="no" required></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- Disclaimer -->
              <div class="p-3 mb-2" style="border:1.5px solid #2986d6; border-radius:7px;">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="disclaimer" id="finalDisclaimerCheckbox">
                  <label class="form-check-label" for="finalDisclaimerCheckbox" style="font-size:0.97rem;">
                    The above documentation verifies that the final claim is ready for billing. Agency verifies that patient record was reviewed, and that the patient meets Medicare coverage criteria, all visits were performed, all orders have been signed by physician and chart has been reviewed for quality assurance. I authorize all visits and/or supplies listed above to be billed to Medicare.<span class="text-danger">*</span>
                  </label>
                </div>
              </div>
              <div class="text-center mt-3">
                <button type="submit" class="btn btn-primary px-4">SUBMIT</button>
                <button type="button" class="btn btn-secondary px-4 ms-2" onclick="window.print()">PRINT</button>
              </div>
            </div>
          </form>
        `;
        document.getElementById('finalBillingAuditForm').onsubmit = async function(e) {
          e.preventDefault();
          const formData = new FormData(this);
          const data = {};
          formData.forEach((v, k) => data[k] = v);
          await submitUserForm('final_billing_audit', data);
        };
      }
    }
    async function submitUserForm(formType, data) {
      if (!loggedInUser) return;
      try {
        const response = await fetch('http://localhost:3000/api/submit-form', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: loggedInUser.id,
            form_type: formType,
            form_data: data
          })
        });
        const resData = await response.json();
        if (resData.success) {
          showLoginFeedback('Form submitted successfully!', true);
          document.getElementById('user-form-area').innerHTML = '';
        } else {
          showLoginFeedback('Failed to submit form.', false);
        }
      } catch (err) {
        showLoginFeedback('Server error. Please try again.', false);
      }
    }
    async function editForm(formId) {
      try {
        const response = await fetch(`http://localhost:3000/api/form/${formId}`);
        const data = await response.json();
        if (data.success) {
          const modal = new bootstrap.Modal(document.getElementById('editFormModal'));
          document.getElementById('edit-form-id').value = formId;
          const formData = data.form.form_data;
          document.getElementById('edit-form-data').value = JSON.stringify(formData, null, 2);
          modal.show();
        } else {
          alert('Error: ' + data.message);
        }
      } catch (err) {
        alert('Error fetching form data');
      }
    }
    async function deleteForm(formId) {
      if (!confirm('Are you sure you want to delete this form?')) return;
      const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
      const body = {
        admin_id: loggedInUser.id,
        user_role: loggedInUser.role
      };

      try {
        const response = await fetch(`http://localhost:3000/api/form/${formId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await response.json();
        if (data.success) {
          alert('Form deleted successfully');
          if (loggedInUser.role === 'superadmin') {
            loadSuperAdminDashboard();
          } else if (loggedInUser.role === 'admin') {
            loadAdminDashboard(loggedInUser.id);
          }
        } else {
          alert(data.message || 'Error deleting form.');
        }
      } catch (err) {
        alert('Error deleting form.');
      }
    }
    async function editUser(userId) {
      try {
        const response = await fetch(`http://localhost:3000/api/user/${userId}`);
        const data = await response.json();
        if (data.success) {
          const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
          document.getElementById('edit-user-id').value = userId;
          document.getElementById('edit-first-name').value = data.user.first_name;
          document.getElementById('edit-last-name').value = data.user.last_name;
          document.getElementById('edit-email').value = data.user.email;
          document.getElementById('edit-role').value = data.user.role;
          modal.show();
        } else {
          alert('Error: ' + data.message);
        }
      } catch (err) {
        alert('Error fetching user data');
      }
    }
    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to delete this user/admin?')) return;

      const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
      if (!loggedInUser || loggedInUser.role !== 'superadmin') {
        alert('You must be logged in as a super admin to delete users/admins.');
        return;
      }

      fetch(`http://localhost:3000/api/superadmin/user/${userId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          admin_id: loggedInUser.id,
          user_role: loggedInUser.role
        })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showLoginFeedback('User/Admin deleted successfully!', true);
            // Ensure we're still logged in as superadmin
            if (loggedInUser && loggedInUser.role === 'superadmin') {
              loadSuperAdminDashboard();
            } else {
              window.location.reload(); // If session is lost, reload the page
            }
          } else {
            alert(data.message || 'Error deleting user/admin');
          }
        })
        .catch(err => {
          alert('Error deleting user/admin. Please try again.');
        });
    }
    function toggleUserList(id) {
      const row = document.getElementById(id);
      if (row.style.display === 'none') {
        row.style.display = 'table-row';
      } else {
        row.style.display = 'none';
      }
    }
    function toggleFormList(id) {
      const row = document.getElementById(id);
      if (row.style.display === 'none') {
        row.style.display = 'table-row';
      } else {
        row.style.display = 'none';
      }
    }
    function toggleCreateForm(type) {
      const formDiv = document.getElementById('slideDownCreateForm');
      if (formDiv.classList.contains('show')) {
        formDiv.classList.remove('show');
      } else {
        formDiv.classList.add('show');
      }
    }
    // Modal logic for notes (dashboard-wide)
    let currentFormType = null;
    function showNoteModal(formType) {
      currentFormType = formType;
      document.getElementById('noteModal').style.display = 'block';
      document.getElementById('modalNoteText').value = '';
      // Set form name in modal
      const formNames = {
        outpatient_therapy: 'Outpatient Therapy Form',
        medicare_eligibility: 'Medicare Eligibility Check',
        home_health_billing_audit: 'Home Health Billing Audit (NOA)',
        coding_needed_list: 'Coding Needed List',
        final_billing_audit: 'Final Billing Audit (PDGM)'
      };
      document.getElementById('noteFormName').innerText = formNames[formType] || '';
    }
    function closeNoteModal() {
      document.getElementById('noteModal').style.display = 'none';
      currentFormType = null;
    }
    function saveNote() {
      const noteText = document.getElementById('modalNoteText').value;
      if (noteText.trim()) {
        // You can implement saving the note to localStorage or backend as needed
        alert('Note for ' + currentFormType + ': ' + noteText);
        closeNoteModal();
      }
    }
  </script>
  <!-- Edit Form Modal -->
  <div class="modal fade" id="editFormModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Form</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit-form-id">
          <div class="mb-3">
            <label class="form-label">Form Data (JSON)</label>
            <textarea class="form-control" id="edit-form-data" rows="10"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveFormEdit()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Edit User Modal -->
  <div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit-user-id">
          <div class="mb-3">
            <label class="form-label">First Name</label>
            <input type="text" class="form-control" id="edit-first-name">
          </div>
          <div class="mb-3">
            <label class="form-label">Last Name</label>
            <input type="text" class="form-control" id="edit-last-name">
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="edit-email">
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select class="form-control" id="edit-role">
              <option value="user">User</option>
              <option value="admin">Admin</option>
              <option value="superadmin">Super Admin</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveUserEdit()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    async function saveFormEdit() {
      const formId = document.getElementById('edit-form-id').value;
      const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
      try {
        const formData = JSON.parse(document.getElementById('edit-form-data').value);
        const response = await fetch(`http://localhost:3000/api/form/${formId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            form_data: formData,
            status: 'final',
            admin_id: loggedInUser.id,
            user_role: loggedInUser.role
          })
        });
        const data = await response.json();
        if (data.success) {
          alert('Form updated successfully');
          bootstrap.Modal.getInstance(document.getElementById('editFormModal')).hide();
          if (loggedInUser.role === 'superadmin') {
            loadSuperAdminDashboard();
          } else if (loggedInUser.role === 'admin') {
            loadAdminDashboard(loggedInUser.id);
          }
        } else {
          alert(data.message || 'Error updating form.');
        }
      } catch (err) {
        alert('Error updating form: ' + err.message);
      }
    }
    async function saveUserEdit() {
      const userId = document.getElementById('edit-user-id').value;
      const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
      const userData = {
        first_name: document.getElementById('edit-first-name').value,
        last_name: document.getElementById('edit-last-name').value,
        email: document.getElementById('edit-email').value,
        role: document.getElementById('edit-role').value,
        admin_id: loggedInUser.id,
        user_role: loggedInUser.role
      };

      try {
        const response = await fetch(`http://localhost:3000/api/user/${userId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(userData)
        });
        const data = await response.json();
        if (data.success) {
          alert('User updated successfully');
          bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
          if (loggedInUser.role === 'superadmin') {
            loadSuperAdminDashboard();
          } else if (loggedInUser.role === 'admin') {
            loadAdminDashboard(loggedInUser.id);
          }
        } else {
          alert(data.message || 'Error updating user.');
        }
      } catch (err) {
        alert('Error updating user.');
      }
    }
  </script>
  <!-- Add JS validation for create admin and create user forms -->
  <script>
    function validateName(name) {
      return name.length >= 2 && name.length <= 30;
    }
    function validatePassword(password) {
      return password.length >= 8 && /[^A-Za-z0-9]/.test(password);
    }
    function showFormError(form, message) {
      let err = form.querySelector('.form-error');
      if (!err) {
        err = document.createElement('div');
        err.className = 'form-error text-danger mb-2';
        form.prepend(err);
      }
      err.textContent = message;
    }
    function clearFormError(form) {
      let err = form.querySelector('.form-error');
      if (err) err.remove();
    }
    // Patch createAdminForm submit
    function patchCreateAdminFormValidation() {
      const form = document.getElementById('createAdminForm');
      if (!form) return;
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        clearFormError(form);
        const first = form.querySelector('#admin-first-name').value.trim();
        const last = form.querySelector('#admin-last-name').value.trim();
        const email = form.querySelector('#admin-email').value.trim();
        const password = form.querySelector('#admin-password').value;

        if (!validateName(first)) {
          showFormError(form, 'First name must be 2-30 characters.'); return false;
        }
        if (last && !validateName(last)) {
          showFormError(form, 'Last name must be 2-30 characters.'); return false;
        }
        if (!validatePassword(password)) {
          showFormError(form, 'Password must be at least 8 characters and contain a special character.'); return false;
        }

        try {
          const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
          if (!loggedInUser || loggedInUser.role !== 'superadmin') {
            showFormError(form, 'You must be logged in as a super admin to create admins.');
            return false;
          }

          const response = await fetch('http://localhost:3000/api/create-admin', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${loggedInUser.id}` // Add authorization header
            },
            body: JSON.stringify({
              creator_role: loggedInUser.role,
              first_name: first,
              last_name: last,
              email: email,
              password: password
            })
          });

          const data = await response.json();
          if (data.success) {
            showLoginFeedback('Admin created successfully!', true);
            form.reset();
            toggleCreateForm('admin'); // Hide the form

            // Refresh the dashboard without reloading the page
            await loadSuperAdminDashboard();

            // Update the loggedInUser in localStorage to maintain session
            localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
          } else {
            showFormError(form, data.message || 'Error creating admin.');
          }
        } catch (err) {
          console.error('Error creating admin:', err);
          showFormError(form, 'Server error. Please try again.');
        }
      }, true);
    }
    // Patch createUserForm submit
    function patchCreateUserFormValidation() {
      const form = document.getElementById('createUserForm');
      if (!form) return;
      form.addEventListener('submit', function(e) {
        clearFormError(form);
        const first = form.querySelector('#user-first-name').value.trim();
        const last = form.querySelector('#user-last-name').value.trim();
        const email = form.querySelector('#user-email').value.trim();
        const password = form.querySelector('#user-password').value;
        if (!validateName(first)) {
          e.preventDefault(); showFormError(form, 'First name must be 2-30 characters.'); return false;
        }
        if (last && !validateName(last)) {
          e.preventDefault(); showFormError(form, 'Last name must be 2-30 characters.'); return false;
        }
        if (!validatePassword(password)) {
          e.preventDefault(); showFormError(form, 'Password must be at least 8 characters and contain a special character.'); return false;
        }
      }, true);
    }
    // Call these after rendering forms
    setTimeout(() => { patchCreateAdminFormValidation(); patchCreateUserFormValidation(); }, 1000);
  </script>
  <script>
    // --- Modal-related functions in global scope ---
    function moveUserModal(userId) {
      fetch('http://localhost:3000/api/superadmin-dashboard')
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const select = document.getElementById('move-user-new-admin');
            select.innerHTML = '';
            data.admins.forEach(a => {
              select.innerHTML += `<option value="${a.admin.id}">${a.admin.first_name} ${a.admin.last_name} (${a.admin.email})</option>`;
            });
            document.getElementById('move-user-id').value = userId;
            new bootstrap.Modal(document.getElementById('moveUserModal')).show();
          }
        });
    }
    function editUserModal(userId) {
      fetch(`http://localhost:3000/api/user/${userId}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const u = data.user;
            document.getElementById('edit-user-admin-id').value = u.id;
            document.getElementById('edit-user-admin-first-name').value = u.first_name;
            document.getElementById('edit-user-admin-last-name').value = u.last_name;
            document.getElementById('edit-user-admin-email').value = u.email;
            document.getElementById('edit-user-admin-password').value = '';
            document.getElementById('edit-user-admin-role').value = u.role;
            new bootstrap.Modal(document.getElementById('editUserAdminModal')).show();
          }
        });
    }
    function deleteUserModal(userId) {
      if (!confirm('Are you sure you want to delete this user/admin?')) return;
      fetch(`http://localhost:3000/api/superadmin/user/${userId}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert('User/Admin deleted successfully');
            loadSuperAdminDashboard();
          } else {
            alert(data.message || 'Error deleting user/admin');
          }
        });
    }
    function saveMoveUser() {
      const userId = document.getElementById('move-user-id').value;
      const newAdminId = document.getElementById('move-user-new-admin').value;
      fetch(`http://localhost:3000/api/superadmin/move-user/${userId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newAdminId })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert('User moved successfully');
            bootstrap.Modal.getInstance(document.getElementById('moveUserModal')).hide();
            loadSuperAdminDashboard();
          } else {
            alert(data.message || 'Error moving user');
          }
        });
    }
    function saveUserAdminEdit() {
      const id = document.getElementById('edit-user-admin-id').value;
      const first_name = document.getElementById('edit-user-admin-first-name').value;
      const last_name = document.getElementById('edit-user-admin-last-name').value;
      const email = document.getElementById('edit-user-admin-email').value;
      const password = document.getElementById('edit-user-admin-password').value;
      const role = document.getElementById('edit-user-admin-role').value;
      fetch(`http://localhost:3000/api/superadmin/user/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ first_name, last_name, email, password, role })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert('User/Admin updated successfully');
            bootstrap.Modal.getInstance(document.getElementById('editUserAdminModal')).hide();
            loadSuperAdminDashboard();
          } else {
            alert(data.message || 'Error updating user/admin');
          }
        });
    }
    function editFormModal(formId) {
      fetch(`http://localhost:3000/api/form/${formId}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const modal = new bootstrap.Modal(document.getElementById('editFormModal'));
            document.getElementById('edit-form-id').value = formId;
            document.getElementById('edit-form-data').value = JSON.stringify(data.form.form_data, null, 2);
            modal.show();
          }
        });
    }
    window.moveUserModal = moveUserModal;
    window.editUserModal = editUserModal;
    window.deleteUserModal = deleteUserModal;
    window.saveMoveUser = saveMoveUser;
    window.saveUserAdminEdit = saveUserAdminEdit;
    window.editFormModal = editFormModal;
  </script>
  <!-- Move User Modal -->
  <div class="modal fade" id="moveUserModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Move User to Another Admin</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="move-user-id">
          <div class="mb-3">
            <label class="form-label">Select New Admin</label>
            <select class="form-control" id="move-user-new-admin"></select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveMoveUser()">Move User</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Edit User/Admin Modal -->
  <div class="modal fade" id="editUserAdminModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit User/Admin</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit-user-admin-id">
          <div class="mb-3">
            <label class="form-label">First Name</label>
            <input type="text" class="form-control" id="edit-user-admin-first-name">
          </div>
          <div class="mb-3">
            <label class="form-label">Last Name</label>
            <input type="text" class="form-control" id="edit-user-admin-last-name">
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="edit-user-admin-email">
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" class="form-control" id="edit-user-admin-password">
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select class="form-control" id="edit-user-admin-role">
              <option value="user">User</option>
              <option value="admin">Admin</option>
              <option value="superadmin">Super Admin</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveUserAdminEdit()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>